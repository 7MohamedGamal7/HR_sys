{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{% if form.instance.pk %}تعديل موظف{% else %}إضافة موظف جديد{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        font-weight: 600;
    }
    .tab-content {
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 20px;
        background-color: #fff;
    }
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-user-plus"></i>
                    {% if form.instance.pk %}تعديل بيانات الموظف{% else %}إضافة موظف جديد{% endif %}
                </h2>
                <a href="{% url 'employees:employee_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-right"></i> العودة للقائمة
                </a>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="employeeForm">
        {% csrf_token %}
        
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="employeeTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab">
                    <i class="fas fa-user"></i> البيانات الشخصية
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button" role="tab">
                    <i class="fas fa-briefcase"></i> بيانات العمل
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="salary-tab" data-bs-toggle="tab" data-bs-target="#salary" type="button" role="tab">
                    <i class="fas fa-money-bill-wave"></i> بيانات الراتب
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                    <i class="fas fa-clock"></i> بيانات الحضور
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bank-tab" data-bs-toggle="tab" data-bs-target="#bank" type="button" role="tab">
                    <i class="fas fa-university"></i> البيانات البنكية
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
                    <i class="fas fa-file-alt"></i> المستندات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contracts-tab" data-bs-toggle="tab" data-bs-target="#contracts" type="button" role="tab">
                    <i class="fas fa-file-contract"></i> العقود
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="insurances-tab" data-bs-toggle="tab" data-bs-target="#insurances" type="button" role="tab">
                    <i class="fas fa-shield-alt"></i> التأمينات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custody-tab" data-bs-toggle="tab" data-bs-target="#custody" type="button" role="tab">
                    <i class="fas fa-box"></i> العهد
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="education-tab" data-bs-toggle="tab" data-bs-target="#education" type="button" role="tab">
                    <i class="fas fa-graduation-cap"></i> المؤهلات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="experience-tab" data-bs-toggle="tab" data-bs-target="#experience" type="button" role="tab">
                    <i class="fas fa-briefcase"></i> الخبرات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab">
                    <i class="fas fa-notes-medical"></i> التأمين الصحي
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="employeeTabContent">
            <!-- Personal Information Tab -->
            <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <div class="form-section-title">المعلومات الشخصية</div>
                <div class="row">
                    <div class="col-md-3">
                        {{ form.emp_code|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.first_name_ar|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.middle_name_ar|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.last_name_ar|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.first_name_en|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.last_name_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ form.national_id|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.passport_number|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.date_of_birth|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        {{ form.gender|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.marital_status|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.nationality|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.religion|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ form.email|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.phone|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.mobile|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        {{ form.address|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.city|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.postal_code|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.photo|as_crispy_field }}
                    </div>
                </div>
            </div>

            <!-- Work Information Tab -->
            <div class="tab-pane fade" id="work" role="tabpanel">
                <div class="form-section-title">بيانات العمل</div>
                <div class="row">
                    <div class="col-md-4">
                        {{ form.department|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.position|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.branch|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.manager|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.employment_type|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ form.hire_date|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.probation_end_date|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.confirmation_date|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.termination_date|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.is_active|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        {{ form.termination_reason|as_crispy_field }}
                    </div>
                </div>
            </div>

            <!-- Salary Information Tab -->
            <div class="tab-pane fade" id="salary" role="tabpanel">
                <div class="form-section-title">بيانات الراتب والبدلات</div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.basic_salary|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.housing_allowance|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.transport_allowance|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.other_allowances|as_crispy_field }}
                    </div>
                </div>
            </div>

            <!-- Attendance Information Tab -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="form-section-title">بيانات الحضور والإجازات</div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.work_shift|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.zk_user_id|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.annual_leave_balance|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.sick_leave_balance|as_crispy_field }}
                    </div>
                </div>
            </div>

            <!-- Bank Information Tab -->
            <div class="tab-pane fade" id="bank" role="tabpanel">
                <div class="form-section-title">البيانات البنكية</div>
                <div class="row">
                    <div class="col-md-4">
                        {{ form.bank_name|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.bank_account_number|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.iban|as_crispy_field }}
                    </div>
                </div>
            </div>

        <!-- Documents Tab -->
        <div class="tab-pane fade" id="documents" role="tabpanel">
                <div class="form-section-title">المستندات</div>
                {% if employee %}
                <div class="card mb-3">
                    <div class="card-header">إضافة مستند</div>
                    <div class="card-body">
                        {{ document_form|crispy }}
                    </div>
                </div>
                {% if documents %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>الاسم</th>
                                <th>النوع</th>
                                <th>تاريخ الإصدار</th>
                                <th>تاريخ الانتهاء</th>
                                <th>ملف</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in documents %}
                            <tr>
                                <td>{{ d.document_name }}</td>
                                <td>{{ d.get_document_type_display }}</td>
                                <td>{{ d.issue_date|date:'Y-m-d' }}</td>
                                <td>{{ d.expiry_date|date:'Y-m-d' }}</td>
                                <td>
                                    {% if d.document_file %}
                                    <a href="{{ d.document_file.url }}" target="_blank" class="btn btn-sm btn-primary"><i class="fas fa-download"></i></a>
                                    {% else %}
                                    <span class="text-muted">لا يوجد</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد مستندات مسجلة</div>
                {% endif %}
                {% else %}
                <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة المستندات</div>
                {% endif %}
        </div>

        <!-- Contracts Tab -->
        <div class="tab-pane fade" id="contracts" role="tabpanel">
            <div class="form-section-title">العقود</div>
            {% if employee %}
            <div class="card mb-3">
                <div class="card-header">إضافة عقد</div>
                <div class="card-body">
                    {{ contract_form|crispy }}
                </div>
            </div>
            {% if contracts %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>رقم العقد</th>
                            <th>النوع</th>
                            <th>البداية</th>
                            <th>النهاية</th>
                            <th>الراتب</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in contracts %}
                        <tr>
                            <td>{{ c.contract_number }}</td>
                            <td>{{ c.get_contract_type_display }}</td>
                            <td>{{ c.start_date|date:'Y-m-d' }}</td>
                            <td>{{ c.end_date|date:'Y-m-d' }}</td>
                            <td>{{ c.salary|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد عقود مسجلة</div>
            {% endif %}
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة العقود</div>
            {% endif %}
        </div>

        <!-- Insurances Tab -->
        <div class="tab-pane fade" id="insurances" role="tabpanel">
            <div class="form-section-title">التأمينات</div>
            {% if employee %}
            <div class="card mb-3">
                <div class="card-header">إضافة تأمين</div>
                <div class="card-body">
                    {{ insurance_form|crispy }}
                </div>
            </div>
            {% if insurances %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>النوع</th>
                            <th>الرقم</th>
                            <th>الشركة</th>
                            <th>البداية</th>
                            <th>النهاية</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in insurances %}
                        <tr>
                            <td>{{ i.get_insurance_type_display }}</td>
                            <td>{{ i.insurance_number }}</td>
                            <td>{{ i.insurance_company }}</td>
                            <td>{{ i.start_date|date:'Y-m-d' }}</td>
                            <td>{{ i.end_date|date:'Y-m-d' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد تأمينات مسجلة</div>
            {% endif %}
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة التأمينات</div>
            {% endif %}
        </div>

        <!-- Custody Tab -->
        <div class="tab-pane fade" id="custody" role="tabpanel">
            <div class="form-section-title">العهد</div>
            {% if employee %}
            <div class="card mb-3">
                <div class="card-header">إضافة عهدة</div>
                <div class="card-body">
                    {{ custody_form|crispy }}
                </div>
            </div>
            {% if custodies %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>النوع</th>
                            <th>الاسم</th>
                            <th>الرقم التسلسلي</th>
                            <th>القيمة</th>
                            <th>تاريخ الاستلام</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cu in custodies %}
                        <tr>
                            <td>{{ cu.get_custody_type_display }}</td>
                            <td>{{ cu.item_name }}</td>
                            <td>{{ cu.serial_number }}</td>
                            <td>{{ cu.item_value }}</td>
                            <td>{{ cu.issue_date|date:'Y-m-d' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد عهد مسجلة</div>
            {% endif %}
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة العهد</div>
            {% endif %}
        </div>

        <!-- Education Tab -->
        <div class="tab-pane fade" id="education" role="tabpanel">
            <div class="form-section-title">المؤهلات</div>
            {% if employee %}
            <div class="card mb-3">
                <div class="card-header">إضافة مؤهل</div>
                <div class="card-body">
                    {{ education_form|crispy }}
                </div>
            </div>
            {% if education %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>الدرجة</th>
                            <th>المجال</th>
                            <th>المؤسسة</th>
                            <th>سنة التخرج</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in education %}
                        <tr>
                            <td>{{ e.degree }}</td>
                            <td>{{ e.field_of_study }}</td>
                            <td>{{ e.institution }}</td>
                            <td>{{ e.graduation_year }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد مؤهلات مسجلة</div>
            {% endif %}
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة المؤهلات</div>
            {% endif %}
        </div>

        <!-- Experience Tab -->
        <div class="tab-pane fade" id="experience" role="tabpanel">
            <div class="form-section-title">الخبرات</div>
            {% if employee %}
            <div class="card mb-3">
                <div class="card-header">إضافة خبرة</div>
                <div class="card-body">
                    {{ experience_form|crispy }}
                </div>
            </div>
            {% if experience %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>الشركة</th>
                            <th>المنصب</th>
                            <th>البداية</th>
                            <th>النهاية</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ex in experience %}
                        <tr>
                            <td>{{ ex.company_name }}</td>
                            <td>{{ ex.position }}</td>
                            <td>{{ ex.start_date|date:'Y-m-d' }}</td>
                            <td>{{ ex.end_date|date:'Y-m-d' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد خبرات مسجلة</div>
            {% endif %}
            {% else %}
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بحفظ بيانات الموظف أولاً لإضافة الخبرات</div>
            {% endif %}
        </div>

        <!-- Health Insurance Tab -->
        <div class="tab-pane fade" id="health" role="tabpanel">
            <div class="form-section-title">التأمين الصحي</div>
            <div class="row">
                <div class="col-md-6">{{ form.health_card|as_crispy_field }}</div>
                <div class="col-md-6">{{ form.health_card_number|as_crispy_field }}</div>
            </div>
            <div class="row">
                <div class="col-md-4">{{ form.health_card_start_date|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.health_card_renewal_date|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.health_card_remaining_days|as_crispy_field }}</div>
            </div>
            <div class="form-section-title">تأمين الدولية</div>
            <div class="row">
                <div class="col-md-6">{{ form.orient_subscription_start_date|as_crispy_field }}</div>
                <div class="col-md-6">{{ form.orient_subscription_expiry_date|as_crispy_field }}</div>
            </div>
            <div class="row">
                <div class="col-md-6">{{ form.orient_incoming_number|as_crispy_field }}</div>
                <div class="col-md-6">{{ form.orient_incoming_date|as_crispy_field }}</div>
            </div>
            <div class="row">
                <div class="col-md-4">{{ form.orient_s1|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.orient_s1_delivery_date|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.orient_s1_receipt_date|as_crispy_field }}</div>
            </div>
            <div class="row">
                <div class="col-md-6">{{ form.orient_insurance_entry_confirmation|as_crispy_field }}</div>
                <div class="col-md-6">{{ form.orient_s6|as_crispy_field }}</div>
            </div>
        </div>
        </div>

        <!-- Form Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> حفظ البيانات
                </button>
                <a href="{% url 'employees:employee_list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i> إلغاء
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

